{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>Enter miRNA Information</h2>

  <div id="error" class="error" style="display:none;"></div>

  <form method="post" id="primerForm">
    <label for="miRNA_name">miRNA Name (e.g., hsa-let-7b-5p):</label>
    <input type="text" name="miRNA_name" id="miRNA_name" placeholder="Start typing..." autocomplete="off">

    <label for="miRNA_sequence">miRNA Sequence (Optional if miRNA Name is selected):</label>
    <textarea name="miRNA_sequence" id="miRNA_sequence" rows="4"></textarea>

    <h3>Concentration Settings</h3>

    <label for="Na_conc">Na<sup>+</sup> Concentration (mM):</label>
    <input type="number" name="Na_conc" step="0.001" value="5" required>

    <label for="Mg_conc">Mg<sup>2+</sup> Concentration (mM):</label>
    <input type="number" name="Mg_conc" step="0.001" value="3" required>

    <label for="dNTPs_conc">dNTPs Concentration (mM):</label>
    <input type="number" name="dNTPs_conc" step="0.0001" value="0.5" required>

    <label for="oligo_conc_rt">Oligo Concentration for RT Reaction (ÂµM):</label>
    <input type="number" name="oligo_conc_rt" step="0.0001" value="0.05" required>

    <label for="oligo_conc_qpcr">Oligo Concentration for qPCR Reaction (ÂµM):</label>
    <input type="number" name="oligo_conc_qpcr" step="0.0001" value="0.4" required>

    <!-- ADVANCED OPTIONS -->
    <details id="advDetails" class="panel" style="margin-top:1rem;">
      <summary>
        <span class="panel-title">
          <span class="chev">â–¸</span>
          <strong>Advanced options</strong>
        </span>
        <span class="panel-actions">
          <button type="button" class="btn-chip" id="themeToggle" title="Toggle light/dark">ðŸŒ“</button>
          <button type="button" class="btn-chip" id="advPresetLo" title="Relax a bit">Relax</button>
          <button type="button" class="btn-chip" id="advPresetHi" title="Be stricter">Tighten</button>
          <button type="button" class="btn-chip btn-primary" id="advReset" title="Reset fields">Reset</button>
        </span>
      </summary>

      <div class="adv-wrap">

        <!-- Energetics & seed -->
        <div class="adv-group">
          <h4>Energetics & seed</h4>

          <!-- Row 1: Î”G min, Î”G max, Î£Î”G max -->
          <div class="adv-grid">
            <div class="field" data-help="Minimum Î”G (more negative = stronger binding).">
              <label>Î”G min (kcal/mol)</label>
              <input type="number" step="0.1" name="dg_min" value="-14">
            </div>
            <div class="field" data-help="Maximum Î”G (upper bound of the window).">
              <label>Î”G max (kcal/mol)</label>
              <input type="number" step="0.1" name="dg_max" value="-8">
            </div>
            <div class="field" data-help="Maximum total Î”G across both ends.">
              <label>Î£Î”G max (kcal/mol)</label>
              <input type="number" step="0.1" name="dg_sum_max" value="-20">
            </div>
          </div>

          <!-- Row 2: seed, Î”G temperature -->
          <div class="adv-grid">
            <div class="field">
              <label>Seed</label>
              <div class="seed-inline">
                <input type="text" name="seed" id="seedInput" value="1" placeholder="e.g. 1">
                <button type="button" id="seedDice" class="icon-btn" title="Random seed">ðŸŽ²</button>
              </div>
            </div>
            <div class="field" data-help="Temperature used for Î”G calculations.">
              <label>Î”G temperature (Â°C)</label>
              <input type="number" step="0.1" name="dg_temp_C" value="37">
            </div>
          </div>

          <!-- Toggles -->
          <div class="adv-grid" style="margin-top:.3rem;">
            <label class="switch"><input type="checkbox" name="randomize_seed"><span>Randomize seed</span></label>
            <label class="switch"><input type="checkbox" name="auto_relax"><span>Auto-relax Î”G if no hits</span></label>
            <label class="switch"><input type="checkbox" name="include_score"><span>Include score</span></label>
          </div>
        </div>

        <!-- Extra output -->
        <div class="adv-group">
          <h4>Extra output</h4>
          <div class="adv-grid">
            <label class="switch"><input type="checkbox" name="include_rt_product"><span>Include RT product</span></label>
            <label class="switch"><input type="checkbox" name="include_ascii"><span>Include ASCII duplex</span></label>
            <label class="switch"><input type="checkbox" name="include_struct"><span>Include RT hairpin MFE</span></label>
          </div>
        </div>

        <!-- Search effort -->
        <div class="adv-group">
          <h4>Search effort</h4>
          <div class="adv-grid">
            <div class="field" data-help="Attempts per hemiprobe pair. Higher = slower, potentially better.">
              <label>Tries per pair</label>
              <input type="number" min="1" max="2000" name="tries_per_pair" value="120">
            </div>
            <div class="field" data-help="Beam width per pair. Controls breadth of search.">
              <label>Beam per pair</label>
              <input type="number" min="1" max="50" name="beam_per_pair" value="3">
            </div>
            <div class="field" data-help="How many candidate outputs to return.">
              <label>How many outputs</label>
              <input type="number" min="1" max="20" name="top_n" value="5">
            </div>
          </div>
        </div>

        <!-- Hemiprobe lengths (Row 1: 5â€², Row 2: 3â€²) -->
        <div class="adv-group">
          <h4>Hemiprobe lengths</h4>
          <!-- Row 1: 5â€² -->
          <div class="adv-grid">
            <div class="field"><label>5â€² hemiprobe length (min)</label><input type="number" min="3" name="l5_min" value="4"></div>
            <div class="field"><label>5â€² hemiprobe length (max)</label><input type="number" min="3" name="l5_max" value="8"></div>
          </div>
          <!-- Row 2: 3â€² -->
          <div class="adv-grid">
            <div class="field"><label>3â€² hemiprobe length (min)</label><input type="number" min="3" name="l3_min" value="4"></div>
            <div class="field"><label>3â€² hemiprobe length (max)</label><input type="number" min="3" name="l3_max" value="8"></div>
          </div>
        </div>

        <!-- qPCR constraints (Row 1: Tm, Row 2: primer length) -->
        <div class="adv-group">
          <h4>qPCR constraints</h4>
          <!-- Row 1: Tm -->
          <div class="adv-grid">
            <div class="field"><label>qPCR Tm min (Â°C)</label><input type="number" step="0.1" name="tm_lo" value="58"></div>
            <div class="field"><label>qPCR Tm max (Â°C)</label><input type="number" step="0.1" name="tm_hi" value="65"></div>
          </div>
          <!-- Row 2: primer length -->
          <div class="adv-grid">
            <div class="field"><label>Primer minimum length</label><input type="number" min="12" name="min_primer_len" value="16"></div>
            <div class="field"><label>Primer maximum length</label><input type="number" min="14" name="max_primer_len" value="25"></div>
          </div>
        </div>

        <!-- Hairpin & random spacers (Row 1: hairpin; Row 2: random) -->
        <div class="adv-group">
          <h4>Hairpin & random spacers</h4>
          <!-- Row 1: hairpin -->
          <div class="adv-grid">
            <div class="field"><label>Hairpin stem length</label><input type="text" name="stem_len" value="7-8" placeholder="8 or 7-9 or 7,8,9"></div>
            <div class="field"><label>Hairpin loop length</label><input type="text" name="loop_len" value="5" placeholder="5 or 4-6 or 4,5,6"></div>
          </div>
          <!-- Row 2: random -->
          <div class="adv-grid">
            <div class="field"><label>Random 5â€² length</label><input type="text" name="rand5_len" value="8-10" placeholder="8 or 8-10 or 8,9,10"></div>
            <div class="field"><label>Random 3â€² length</label><input type="text" name="rand3_len" value="8-10" placeholder="8 or 8-10 or 8,9,10"></div>
          </div>
        </div>

      </div>
    </details>

    <button type="submit" class="primary-submit" style="margin-top:1rem;">Design Primers</button>
  </form>

  <!-- Single-page results go here -->
  <div id="results" class="results" style="margin-top:20px;"></div>
</div>

<!-- jQuery + jQuery UI (for autocomplete). Include the jQuery UI CSS in your base.html or here. -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script>
  function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(() => {
      const original = button.innerHTML;
      button.innerHTML = 'âœ…';
      setTimeout(() => button.innerHTML = original, 1000);
    });
  }

  $(function () {
    // Autocomplete
    $('#miRNA_name').autocomplete({
      source: function(request, response) {
        $.ajax({
          url: "{{ url_for('autocomplete') }}",
          dataType: "json",
          data: { q: request.term },
          success: function(data) { response(data.suggestions); }
        });
      },
      minLength: 1
    });

    // AJAX submit
    $('#primerForm').on('submit', function (e) {
      e.preventDefault();
      const form = e.currentTarget;
      const btn = $(form).find('button[type="submit"]');
      btn.prop('disabled', true).text('Designingâ€¦');

      fetch("{{ url_for('design') }}", {
        method: "POST",
        body: new FormData(form)
      })
      .then(async (r) => {
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Request failed');
        renderResults(data);
      })
      .catch(err => {
        $('#results').html('<div class="error">'+ (err.message || 'Error') +'</div>');
      })
      .finally(() => {
        btn.prop('disabled', false).text('Design Primers');
      });
    });

    function renderResults(res) {
      let html = `
        <h2>Top RT Primer Designs</h2>
        <p><strong>miRNA:</strong> ${escapeHtml(res.miRNA_name)}<br>
        <strong>miRNA sequence (RNA):</strong> ${escapeHtml(res.miRNA_sequence)}<br>
        <strong>cDNA (DNA):</strong> ${escapeHtml(res.cDNA_sequence)}<br>
        <strong>Î”G window:</strong> [${res.dg_window[0]}, ${res.dg_window[1]}] kcal/mol<br>
        <strong>Seed used:</strong> ${res.seed_used}</p>
      `;

      if (!res.candidates || !res.candidates.length) {
        html += '<div class="error">No valid designs found under current constraints.</div>';
        $('#results').html(html);
        return;
      }

      if (res.advanced_used) {
        const a = res.advanced_used;
        html += `<details style="margin:.5rem 0;"><summary><b>Advanced used</b></summary>
          <div>Î”G temp: ${a.dg_temp_C} Â°C; Î£Î”G max: ${a.dg_sum_max}</div>
          <div>Tries / Beam / Outputs: ${a.tries_per_pair} / ${a.beam_per_pair} / ${a.top_n}</div>
          <div>3â€² length: [${a.l3_range[0]}, ${a.l3_range[1]}]; 5â€² length: [${a.l5_range[0]}, ${a.l5_range[1]}]</div>
          <div>qPCR Tm: [${a.tm_window[0]}, ${a.tm_window[1]}] Â°C; primer length: ${a.min_primer_len}-${a.max_primer_len}</div>
          <div>Stem/loop: ${a.stem_len}; Random5: ${a.rand5_len}; Random3: ${a.rand3_len}</div>
        </details>`;
      }

      html += '<ol>';
      res.candidates.forEach(c => {
        html += `
          <li style="margin-bottom:1rem;">
            <div><strong>RT primer:</strong> <span style="word-break:break-all;">${c.colored_html || ''}</span></div>
            <div><em>RT Tm / GC:</em> ${c.RT_primer_Tm || 'N/A'}, ${c.RT_primer_GC || 'N/A'}</div>
            <div><em>Î”G (5â€²):</em> ${c.dg5 || 'N/A'} &nbsp; <em>Î”G (3â€²):</em> ${c.dg3 || 'N/A'} &nbsp; <em>Î£Î”G:</em> ${c.dg_sum || 'N/A'}</div>
            <div><em>Forward primer:</em> ${c.Forward_primer || ''} (${c.Forward_primer_Tm || 'N/A'})</div>
            <div><em>Reverse primer:</em> ${c.Reverse_primer || ''} (${c.Reverse_primer_Tm || 'N/A'})</div>
            ${Object.prototype.hasOwnProperty.call(c,'rt_product')
              ? `<div><em>RT product:</em> <span style="word-break:break-all;">${c.rt_product}</span></div>`
              : ``}
            ${Object.prototype.hasOwnProperty.call(c,'heterodimer_ascii')
              ? `<pre>${c.heterodimer_ascii}</pre>`
              : ``}
            ${Object.prototype.hasOwnProperty.call(c,'rt_struct_42C')
              ? `<div><em>RT hairpin @42Â°C:</em> ${c.rt_struct_42C} &nbsp; <em>MFE:</em> ${c.rt_mfe_42C || 'N/A'}</div>`
              : ``}
            ${Object.prototype.hasOwnProperty.call(c,'score')
              ? `<div><em>Score:</em> ${c.score}</div>`
              : ``}
          </li>`;
      });
      html += '</ol>';
      $('#results').html(html);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
      );
    }

    // Seed dice button -> fill random 32-bit seed
    const seedBtn = document.getElementById('seedDice');
    const seedInputEl = document.getElementById('seedInput');
    if (seedBtn && seedInputEl) {
      seedBtn.addEventListener('click', () => {
        const buf = new Uint32Array(1);
        (window.crypto || window.msCrypto).getRandomValues(buf);
        seedInputEl.value = buf[0].toString();
      });
    }

    // Remember Advanced panel open/closed state + optional UX for seed disabling
    document.addEventListener('DOMContentLoaded', () => {
      const adv = document.getElementById('advDetails');
      if (adv) {
        const saved = localStorage.getItem('advOpen');
        if (saved === '1') adv.open = true;
        adv.addEventListener('toggle', () => {
          localStorage.setItem('advOpen', adv.open ? '1' : '0');
        });
      }
      const randCb = document.querySelector('input[name="randomize_seed"]');
      const seedInput = document.getElementById('seedInput');
      const seedDice = document.getElementById('seedDice');
      function syncSeedDisabled() {
        const on = randCb && randCb.checked;
        if (seedInput) seedInput.disabled = on;
        if (seedDice) seedDice.disabled = on;
      }
      if (randCb) {
        randCb.addEventListener('change', syncSeedDisabled);
        syncSeedDisabled();
      }
    });

    // Reset only Advanced fields
    document.getElementById('advReset')?.addEventListener('click', () => {
      const adv = document.getElementById('advDetails');
      const inputs = adv.querySelectorAll('input, textarea, select');
      inputs.forEach(el => {
        if (el.type === 'checkbox' || el.type === 'radio') el.checked = el.defaultChecked;
        else el.value = el.defaultValue;
        el.dispatchEvent(new Event('change', {bubbles:true}));
        el.dispatchEvent(new Event('input', {bubbles:true}));
      });
    });

    // Quick presets
    const setVal = (name, v) => { const el = document.querySelector(`[name="${name}"]`); if (el) el.value = v; };
    document.getElementById('advPresetLo')?.addEventListener('click', () => {
      setVal('dg_min', -13); setVal('dg_max', -7); setVal('dg_sum_max', -18);
      setVal('tries_per_pair', 80); setVal('beam_per_pair', 3);
    });
    document.getElementById('advPresetHi')?.addEventListener('click', () => {
      setVal('dg_min', -16); setVal('dg_max', -9); setVal('dg_sum_max', -24);
      setVal('tries_per_pair', 160); setVal('beam_per_pair', 5);
    });

    // Theme toggle persists
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('uiTheme');
      if (saved === 'dark') root.classList.add('theme-dark');
      document.getElementById('themeToggle')?.addEventListener('click', () => {
        root.classList.toggle('theme-dark');
        localStorage.setItem('uiTheme', root.classList.contains('theme-dark') ? 'dark' : 'light');
      });
    })();
  });
</script>
{% endblock %}
