{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>Enter miRNA Information</h2>

  <style>
    /* Tiny helpers just for this page */
    .adv-row { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; }
    .short-input { width: 120px; }
    .seed-group { display:flex; gap:.4rem; align-items:center; }
    .icon-btn { padding:.2rem .4rem; border:1px solid #ccc; background:#fafafa; cursor:pointer; }
    .check-inline { display:flex; align-items:center; gap:.4rem; }
    .error { color:#b00020; margin:.5rem 0; }
    .results pre { font-family:monospace; white-space:pre; }
  </style>

  <div id="error" class="error" style="display:none;"></div>

  <form method="post" id="primerForm">
    <label for="miRNA_name">miRNA Name (e.g., hsa-let-7b-5p):</label>
    <input type="text" name="miRNA_name" id="miRNA_name" placeholder="Start typing..." autocomplete="off">

    <label for="miRNA_sequence">miRNA Sequence (Optional if miRNA Name is selected):</label>
    <textarea name="miRNA_sequence" id="miRNA_sequence" rows="4"></textarea>

    <h3>Concentration Settings</h3>

    <label for="Na_conc">Na<sup>+</sup> Concentration (mM):</label>
    <input type="number" name="Na_conc" step="0.001" value="5" required>

    <label for="Mg_conc">Mg<sup>2+</sup> Concentration (mM):</label>
    <input type="number" name="Mg_conc" step="0.001" value="3" required>

    <label for="dNTPs_conc">dNTPs Concentration (mM):</label>
    <input type="number" name="dNTPs_conc" step="0.0001" value="0.5" required>

    <label for="oligo_conc_rt">Oligo Concentration for RT Reaction (ÂµM):</label>
    <input type="number" name="oligo_conc_rt" step="0.0001" value="0.05" required>

    <label for="oligo_conc_qpcr">Oligo Concentration for qPCR Reaction (ÂµM):</label>
    <input type="number" name="oligo_conc_qpcr" step="0.0001" value="0.4" required>

    <!-- ADVANCED OPTIONS (collapsed by default). All checkboxes OFF by default. -->
    <details id="advDetails" style="margin-top:1rem;">
      <summary style="cursor:pointer;"><strong>Advanced options</strong></summary>

      <div class="adv-row" style="margin-top:.75rem;">
        <label>Î”G min (kcal/mol)
          <input type="number" step="0.1" name="dg_min" value="-14">
        </label>
        <label>Î”G max (kcal/mol)
          <input type="number" step="0.1" name="dg_max" value="-9">
        </label>

        <div class="seed-group">
          <label>Seed
            <input type="text" name="seed" id="seedInput" class="short-input" value="13" placeholder="e.g. 13">
          </label>
          <button type="button" id="seedDice" class="icon-btn" title="Random seed">ðŸŽ²</button>
        </div>
      </div>

      <div class="adv-row">
        <label class="check-inline"><input type="checkbox" name="randomize_seed"> Randomize seed</label>
        <label class="check-inline"><input type="checkbox" name="auto_relax"> Auto-relax Î”G if no hits</label>
        <label class="check-inline"><input type="checkbox" name="include_score"> Include score</label>
      </div>

      <div class="adv-row" style="margin-top:.5rem;">
        <label class="check-inline"><input type="checkbox" name="include_rt_product"> Include RT product</label>
        <label class="check-inline"><input type="checkbox" name="include_ascii"> Include ASCII duplex</label>
        <label class="check-inline"><input type="checkbox" name="include_struct"> Include RT hairpin MFE</label>
      </div>
    </details>

    <button type="submit" style="margin-top:1rem;">Design Primers</button>
  </form>

  <!-- Single-page results go here -->
  <div id="results" class="results" style="margin-top:20px;"></div>
</div>

<!-- jQuery + jQuery UI (for autocomplete). Include the jQuery UI CSS in your base.html or here. -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script>
  function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(() => {
      const original = button.innerHTML;
      button.innerHTML = 'âœ…';
      setTimeout(() => button.innerHTML = original, 1000);
    });
  }

  $(function () {
    // Autocomplete
    $('#miRNA_name').autocomplete({
      source: function(request, response) {
        $.ajax({
          url: "{{ url_for('autocomplete') }}",
          dataType: "json",
          data: { q: request.term },
          success: function(data) { response(data.suggestions); }
        });
      },
      minLength: 1
    });

    // AJAX submit
    $('#primerForm').on('submit', function (e) {
      e.preventDefault();
      const form = e.currentTarget;
      const btn = $(form).find('button[type="submit"]');
      btn.prop('disabled', true).text('Designingâ€¦');

      fetch("{{ url_for('design') }}", {
        method: "POST",
        body: new FormData(form)
      })
      .then(async (r) => {
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Request failed');
        renderResults(data);
      })
      .catch(err => {
        $('#results').html('<div class="error">'+ (err.message || 'Error') +'</div>');
      })
      .finally(() => {
        btn.prop('disabled', false).text('Design Primers');
      });
    });

    function renderResults(res) {
      let html = `
        <h2>Top RT Primer Designs</h2>
        <p><strong>miRNA:</strong> ${escapeHtml(res.miRNA_name)}<br>
           <strong>miRNA sequence (RNA):</strong> ${escapeHtml(res.miRNA_sequence)}<br>
           <strong>cDNA (DNA):</strong> ${escapeHtml(res.cDNA_sequence)}<br>
           <strong>Î”G window:</strong> [${res.dg_window[0]}, ${res.dg_window[1]}] kcal/mol<br>
           <strong>Seed used:</strong> ${res.seed_used}</p>
      `;

      if (!res.candidates || !res.candidates.length) {
        html += '<div class="error">No valid designs found under current constraints.</div>';
        $('#results').html(html);
        return;
      }

      html += '<ol>';
      res.candidates.forEach(c => {
        html += `
          <li style="margin-bottom:1rem;">
            <div><strong>RT primer:</strong> <span style="word-break:break-all;">${c.colored_html || ''}</span></div>
            <div><em>RT Tm / GC:</em> ${c.RT_primer_Tm || 'N/A'}, ${c.RT_primer_GC || 'N/A'}</div>
            <div><em>Î”G (5â€²):</em> ${c.dg5 || 'N/A'} &nbsp; <em>Î”G (3â€²):</em> ${c.dg3 || 'N/A'} &nbsp; <em>Î£Î”G:</em> ${c.dg_sum || 'N/A'}</div>
            <div><em>Forward primer:</em> ${c.Forward_primer || ''} (${c.Forward_primer_Tm || 'N/A'})</div>
            <div><em>Reverse primer:</em> ${c.Reverse_primer || ''} (${c.Reverse_primer_Tm || 'N/A'})</div>
            ${Object.prototype.hasOwnProperty.call(c,'rt_product')
              ? `<div><em>RT product:</em> <span style="word-break:break-all;">${c.rt_product}</span></div>`
              : ``}
            ${Object.prototype.hasOwnProperty.call(c,'heterodimer_ascii')
              ? `<pre>${c.heterodimer_ascii}</pre>`
              : ``}
            ${Object.prototype.hasOwnProperty.call(c,'rt_struct_42C')
              ? `<div><em>RT hairpin @42Â°C:</em> ${c.rt_struct_42C} &nbsp; <em>MFE:</em> ${c.rt_mfe_42C || 'N/A'}</div>`
              : ``}
            ${Object.prototype.hasOwnProperty.call(c,'score')
              ? `<div><em>Score:</em> ${c.score}</div>`
              : ``}
          </li>`;
      });
      html += '</ol>';
      $('#results').html(html);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
      );
    }

    // Seed dice button -> fill random 32-bit seed
    const seedBtn = document.getElementById('seedDice');
    const seedInput = document.getElementById('seedInput');
    if (seedBtn && seedInput) {
      seedBtn.addEventListener('click', () => {
        const buf = new Uint32Array(1);
        (window.crypto || window.msCrypto).getRandomValues(buf);
        seedInput.value = buf[0].toString();
      });
    }

    // Remember Advanced panel open/closed state
    document.addEventListener('DOMContentLoaded', () => {
        const adv = document.getElementById('advDetails');
        if (adv) {
        const saved = localStorage.getItem('advOpen');
        if (saved === '1') adv.open = true;
        adv.addEventListener('toggle', () => {
            localStorage.setItem('advOpen', adv.open ? '1' : '0');
        });
        }

        // Optional UX: disable seed input when "Randomize seed" is checked
        const randCb = document.querySelector('input[name="randomize_seed"]');
        const seedInput = document.getElementById('seedInput');
        const seedDice = document.getElementById('seedDice');
        function syncSeedDisabled() {
        const on = randCb && randCb.checked;
        if (seedInput) seedInput.disabled = on;
        if (seedDice) seedDice.disabled = on;
        }
        if (randCb) {
        randCb.addEventListener('change', syncSeedDisabled);
        syncSeedDisabled();
        }
    });
  });
</script>
{% endblock %}
